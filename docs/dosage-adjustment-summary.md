# TDM Simulation 용량 조정 옵션 제공 정책 및 차트 정책 변경사항

## 📋 개요
TDM Simulation에서 "용량 조정하기" 및 "용량&시간 조정하기" 기능의 옵션 제공 정책과 차트 표시 정책이 개선되었습니다.

---

## 🎯 주요 변경사항

### 1. 용량 조정 옵션 제공 정책

#### 시나리오별 옵션 생성 방식

| 시나리오 | 조건 | 옵션 생성 방식 | 정렬 방식 |
|---------|------|--------------|----------|
| **목표치 미도달** | 현재 TDM 결과 < 목표 범위 | 현용법 + 목표치 도달 용량부터 상향 12개 | 현용법(1순위) + 추천 12개 오름차순 |
| **목표치 초과** | 현재 TDM 결과 > 목표 범위 | 현용법 + 목표치 도달 용량부터 하향 12개 | 현용법(1순위) + 추천 12개 내림차순 |
| **목표치 도달** | 목표 범위 내 | 현용법 중심 하향 6개 + 상향 6개 (모두 API 검증) | 하향 6개 + 현용법 + 상향 6개 오름차순 |

#### 개선 사항
- ✅ **현용법 용량을 첫 번째 옵션으로 명시적 추가** (모든 시나리오 공통)
- ✅ **목표치 도달 시 모든 옵션을 API로 검증** (목표치 도달하지 않는 옵션 제외)
- ✅ **상향/하향 검증 중 목표치 벗어나면 해당 방향 검증 중단** (성능 개선)
- ✅ **캐시 재사용**: 이미 검증된 옵션은 API 재호출 없이 사용

#### 옵션 버튼 표시
- 로딩 중: "제안을 계산 중..." 메시지 표시
- 로딩 완료 후: 옵션 버튼 표시
- **버튼 표기 방식 통일**:
  - 위쪽: 용량 + 단위정보 (예: "345 mg")
  - 아래쪽: 현용법인 경우 "현용법", 아니면 빈 문자열
- 모든 버튼의 높이를 70px로 고정
- 현용법 옵션은 자동으로 하이라이트 처리

---

### 2. 차트 그리기 정책

#### 최초 차트 표시
- ✅ **카드 생성 시 현용법 차트만 표시** (용법조정 결과 없음)
- ✅ 이미 호출된 TDM 결과가 있으면 즉시 차트 렌더링 (추가 API 호출 없음)

#### 사용자 선택 시 차트 업데이트
- **현용법 용량 선택**: 현용법 차트만 표시 (API 호출 없음)
- **추천 옵션 선택**: 현용법 + 용법조정 결과 함께 표시 (캐시 확인 후 필요 시 API 호출 1회)

---

### 3. API 호출 최적화

#### 호출 시점
- **옵션 생성 시**: 목표치 도달 검색을 위한 API 호출만 수행
- **사용자 선택 시**: 선택한 옵션에 대한 API 호출 1회 (캐시 있으면 생략)

#### 성능 개선
- 목표치 도달 케이스에서 상향 옵션 검증 중 목표치 초과 확인 시 상향 검증 중단
- 목표치 도달 케이스에서 하향 옵션 검증 중 목표치 미도달 확인 시 하향 검증 중단
- 검증된 옵션 결과는 캐시에 저장하여 재사용

---

### 4. 옵션 재사용 정책

#### 카드 간 옵션 공유
- "용량 조정하기" 카드와 "용량&시간 조정하기" 카드 간 옵션 재사용
- 한 카드에서 이미 적정 용량을 찾은 경우, 다른 카드 추가 시 API 재호출 없이 옵션 재사용
- 재사용 시 캐시 데이터도 함께 복사하여 선택 시 즉시 차트 표시

---

## 📊 사용자 플로우

### "용량 조정하기" 선택 시
1. 카드 생성 → **현용법 차트 즉시 표시**
2. 로딩 중 표시 ("제안을 계산 중...")
3. 현재 TDM 결과 분석 → 시나리오 판단
4. 목표치 검색 (필요 시) → 적정 용량 찾기
5. 옵션 생성: **현용법 + 추천 최대 12개**
6. 옵션 버튼 표시 (현용법 자동 하이라이트)
7. 사용자 선택:
   - 현용법 선택 → 현용법 차트만 표시
   - 추천 옵션 선택 → 현용법 + 용법조정 결과 표시

---

## 🔧 기술적 세부사항

### 용법 조정 단위(Step)
- 기본값: 10mg
- Cyclosporin (경구, Capsule/Tablet): 25mg

### 목표치 검색 제한
- 최대 20단계까지 검색 (현재 용량 ±200mg 범위)
- 연속 5회 실패 시 조기 중단

### 에러 처리
- 503 에러: 최대 7회 재시도 (지수 백오프)
- 네트워크 에러: 자동 재시도 및 사용자 피드백

---

## ✅ 개선 효과

1. **사용자 경험 향상**
   - 최초 차트 즉시 표시로 대기 시간 감소
   - 현용법 옵션 명시적 제공으로 비교 용이

2. **성능 개선**
   - 불필요한 API 호출 감소 (목표치 벗어난 옵션 검증 중단)
   - 캐시 재사용으로 응답 속도 향상

3. **정확성 향상**
   - 목표치 도달 시 모든 옵션 API 검증으로 신뢰성 향상
   - 옵션 정렬 정책 개선으로 직관적 선택 가능

